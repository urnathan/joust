# Joust Test Suite		-*- mode:Makefile -*-
# Copyright (C) 2020 Nathan Sidwell, nathan@acm.org
# Not For Distribution

TESTS := $(patsubst $(srcdir)/%.cc,%,\
	$(wildcard $(srcdir)/tests/*/*.cc))

TESTDIRS = $(shell cd $(srcdir)/${<D} ; echo *(/))

check:: tests/joust.defs all $(TESTS)
	+cd ${<D} ; JOUST=${<F} ../joust joust $(TESTDIRS)

tests/joust.defs: tests/Makesub
	echo '# Automatically generated by Make' >$@
	echo srcdir=../${srcdir}/tests/ >>$@
	echo timeout=1 >>$@
	echo memlimit=1 >>$@
	echo cpulimit=1 >>$@
	echo filesizelimit=1 >>$@

$(TESTS): %: %.o libjoust.a libnms.a
	$(CXX) $(LDFLAGS) $< -ljoust -lnms $(LIBS) -o $@

clean::
	rm -f $(TESTS)
	rm -f $(TESTS:=.o) $(TESTS:=.d)

ifeq ($(filter clean%,$(MAKECMDGOALS)),)
-include $(TESTS:=.d)
endif
