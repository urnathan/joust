# Joust Test Suite		-*- mode:Makefile -*-
# Copyright (C) 2020 Nathan Sidwell, nathan@acm.org
# License: Affero GPL v3.0

TESTS := $(patsubst $(srcdir)/%.cc,%,\
	$(wildcard $(srcdir)/tests/*/*.cc))

TESTDIRS = $(shell cd $(srcdir)/${<D} ; echo *(/))

check: PATH := ..:$(PATH)
check:: tests/joust.defs $(TESTS)
	+cd ${<D} && JOUST=${<F} aloy -t kratos -o joust \
	  -g ../$(srcdir)/tests/jouster $(TESTDIRS)

tests/joust.defs: tests/Makesub
	echo '# Automatically generated by Make' >$@
	echo "srcdir=../${srcdir}/tests/" >>$@
	echo "timelimit=60" >>$@
	echo "memlimit=1" >>$@
	echo "cpulimit=60" >>$@
	echo "filelimit=1" >>$@
	echo "SHELL=$(SHELL)" >>$@

$(TESTS): %: %.o libjoust.a libnms.a
	$(CXX) $(LDFLAGS) $< -ljoust -lnms $(LIBS) -o $@

clean::
	rm -f $(TESTS)
	rm -f $(TESTS:=.o) $(TESTS:=.d)

ifeq ($(filter clean%,$(MAKECMDGOALS)),)
-include $(TESTS:=.d)
endif
